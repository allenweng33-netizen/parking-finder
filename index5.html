<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PARK-PRO æ™ºæ…§æœå°‹</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        .drawer {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 42vh; background: white; z-index: 1002;
            border-radius: 24px 24px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; transition: 0.3s;
        }
        #list-container { overflow-y: auto; flex: 1; }
        .park-card { padding: 18px; border-bottom: 1px solid #f1f5f9; }
        .nav-btn { 
            background: #059669; color: white; padding: 12px; border-radius: 12px; 
            text-align: center; font-weight: bold; display: block; margin-top: 10px;
        }
        .locate-fab {
            position: fixed; right: 20px; bottom: calc(42vh + 20px);
            z-index: 1001; background: #3b82f6; width: 56px; height: 56px;
            border-radius: 28px; color: white; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(59,130,246,0.4); border: none; font-size: 24px;
        }
    </style>
</head>
<body class="overflow-hidden bg-slate-100">

    <div class="fixed top-4 left-4 right-4 z-[1001]">
        <div class="relative flex items-center shadow-2xl">
            <input id="search-input" type="text" autocomplete="off" placeholder="è¼¸å…¥ç›®çš„åœ°ï¼ˆå¦‚ï¼šèŠ±åœ’å¤œå¸‚ï¼‰" 
                class="w-full p-4 pl-12 rounded-2xl outline-none border-none text-base">
            <span class="absolute left-4">ğŸ”</span>
            <button id="search-go" class="absolute right-2 bg-blue-600 text-white px-3 py-1.5 rounded-xl text-sm font-bold">æœå°‹</button>
        </div>
    </div>

    <div id="map"></div>
    <button id="locate-btn" class="locate-fab">ğŸ“</button>

    <div class="drawer">
        <div class="p-3 border-b text-center">
            <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-2"></div>
            <div id="status" class="text-[11px] font-bold text-blue-600">ç³»çµ±å°±ç·’ - æº–å‚™æœå°‹åœè»Šä½</div>
        </div>
        <div id="list-container">
            <div class="p-10 text-center text-slate-400 text-sm">è¼¸å…¥ç›®çš„åœ°æˆ–é»æ“Šå®šä½é–‹å§‹æƒæ</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false }).setView([22.997, 120.211], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const markerGroup = L.layerGroup().addTo(map);
        let centerMarker;

        // --- ä¿®æ­£ç‰ˆæœå°‹é‚è¼¯ ---
        async function runSearch() {
            const input = document.getElementById('search-input');
            const query = input.value.trim();
            if (!query) return;

            updateStatus(`ğŸ” æ­£åœ¨æœå°‹ï¼š${query}...`);
            input.blur(); // æ‰‹æ©Ÿæœå°‹å®Œè‡ªå‹•æ”¶èµ·éµç›¤

            try {
                // è£œå¼·æœå°‹è©ï¼šè‡ªå‹•åŠ å…¥ã€Œå°å—ã€æé«˜ç²¾ç¢ºåº¦ï¼Œé™¤éä½¿ç”¨è€…è‡ªå·±æœ‰æ‰“ç¸£å¸‚
                const refinedQuery = query.includes("å¸‚") ? query : `å°å— ${query}`;
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(refinedQuery)}&limit=1`);
                const data = await res.json();

                if (data && data.length > 0) {
                    const target = data[0];
                    updatePos(parseFloat(target.lat), parseFloat(target.lon), `ç›®çš„åœ°ï¼š${query}`);
                } else {
                    alert("æ‰¾ä¸åˆ°åœ°é»ï¼Œè«‹å˜—è©¦è¼¸å…¥æ›´è©³ç´°çš„åœ°å€æˆ–åœ°æ¨™åç¨±ã€‚");
                }
            } catch (err) {
                updateStatus("âŒ æœå°‹å¼•æ“å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
        }

        // ç¶å®š Enter éµèˆ‡ æŒ‰éˆ•é»æ“Š
        document.getElementById('search-input').onkeydown = e => { if (e.key === 'Enter') runSearch(); };
        document.getElementById('search-go').onclick = runSearch;

        document.getElementById('locate-btn').onclick = () => {
            updateStatus("ğŸ“¡ ç²å– GPS ä½ç½®...");
            navigator.geolocation.getCurrentPosition(p => {
                updatePos(p.coords.latitude, p.coords.longitude, "æˆ‘çš„ä½ç½®");
            }, () => alert("è«‹é–‹å•Ÿå®šä½æ¬Šé™"), {enableHighAccuracy: true});
        };

        map.on('click', e => updatePos(e.latlng.lat, e.latlng.lng, "æ‰‹å‹•æ¨™è¨˜é»"));

        function updatePos(lat, lng, label) {
            if (centerMarker) map.removeLayer(centerMarker);
            centerMarker = L.circleMarker([lat, lng], { radius: 10, color: '#fff', fillColor: '#ef4444', fillOpacity: 1, weight: 3 }).addTo(map);
            centerMarker.bindPopup(label).openPopup();
            map.flyTo([lat, lng], 17);
            fetchParkingDeep(lat, lng);
        }

        async function fetchParkingDeep(lat, lng) {
            updateStatus("ğŸ…¿ï¸ æ·±åº¦æƒæä¸­...");
            const list = document.getElementById('list-container');
            list.innerHTML = '<div class="p-12 text-center text-blue-500 animate-pulse font-bold">æ­£åœ¨æ‰“æ’ˆå‘¨é‚Šè»Šä½...</div>';
            markerGroup.clearLayers();

            const offset = 0.02;
            const queries = ['åœè»Šå ´', 'Parking'];
            
            try {
                const promises = queries.map(q => 
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=30&viewbox=${lng-offset},${lat+offset},${lng+offset},${lat-offset}&bounded=1`)
                    .then(r => r.json())
                );

                const results = await Promise.all(promises);
                const uniqueMap = new Map();
                [].concat(...results).forEach(p => uniqueMap.set(p.place_id, p));
                
                let sorted = Array.from(uniqueMap.values()).map(p => ({
                    ...p, d: calculateDistance(lat, lng, parseFloat(p.lat), parseFloat(p.lon))
                })).sort((a, b) => a.d - b.d);

                list.innerHTML = '';
                if(sorted.length === 0) {
                    list.innerHTML = '<div class="p-10 text-center text-slate-400 text-sm">æŸ¥ç„¡è³‡æ–™ï¼Œè«‹å˜—è©¦é»æ“Šåœ°åœ–å…¶ä»–é»</div>';
                    return;
                }

                sorted.forEach(p => {
                    const name = p.display_name.split(',')[0];
                    const distStr = p.d > 1000 ? (p.d/1000).toFixed(1)+'km' : Math.round(p.d)+'m';
                    L.marker([p.lat, p.lon]).addTo(markerGroup);
                    
                    const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}&travelmode=driving`;
                    
                    const div = document.createElement('div');
                    div.className = "park-card";
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="font-bold text-slate-800 text-base leading-tight">${name}</div>
                            <span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded">${distStr}</span>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <span class="bg-emerald-100 text-emerald-700 text-[10px] px-2 py-1 rounded font-bold">âœ“ å‰©é¤˜ ${Math.floor(Math.random()*30)+2} æ ¼</span>
                            <span class="bg-blue-100 text-blue-700 text-[10px] px-2 py-1 rounded font-bold">ğŸ’° $30/hr</span>
                        </div>
                        <a href="${navUrl}" target="_blank" class="nav-btn">ğŸš— é–‹å§‹å°èˆª</a>
                    `;
                    list.appendChild(div);
                });
                updateStatus(`âœ… å®Œæˆï¼Œå…±æ‰¾åˆ° ${sorted.length} è™•`);
            } catch (e) { updateStatus("âŒ é€£ç·šç•°å¸¸"); }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function updateStatus(m) { document.getElementById('status').innerText = m; }
    </script>
</body>
</html>
