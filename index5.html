<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PARK-PRO | ç²¾ç¢ºå°èˆªç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        .drawer {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 42vh; background: white; z-index: 1002;
            border-radius: 24px 24px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            display: flex; flex-direction: column;
        }
        #list-container { overflow-y: auto; flex: 1; padding-bottom: 20px; }
        .park-card { padding: 18px; border-bottom: 1px solid #f1f5f9; }
        .nav-btn { 
            background: #059669; color: white; padding: 12px; border-radius: 12px; 
            text-align: center; font-weight: bold; display: block; margin-top: 10px;
        }
        .dist-tag { background: #f1f5f9; color: #475569; font-size: 11px; padding: 2px 8px; border-radius: 99px; font-weight: 700; }
        .locate-fab {
            position: fixed; right: 20px; bottom: calc(42vh + 20px);
            z-index: 1001; background: #3b82f6; width: 56px; height: 56px;
            border-radius: 28px; color: white; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(59,130,246,0.4); border: none; font-size: 24px;
        }
    </style>
</head>
<body class="overflow-hidden bg-slate-100">

    <div class="fixed top-4 left-4 right-4 z-[1001]">
        <div class="relative flex items-center shadow-2xl">
            <input id="search-input" type="text" placeholder="æœå°‹ç›®çš„åœ°ï¼ˆå¦‚ï¼šèµ¤å´æ¨“ï¼‰" 
                class="w-full p-4 pl-12 rounded-2xl outline-none border-none text-base bg-white">
            <span class="absolute left-4">ğŸ”</span>
            <button id="search-go" class="absolute right-2 bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold">æœå°‹</button>
        </div>
    </div>

    <div id="map"></div>
    <button id="locate-btn" class="locate-fab">ğŸ“</button>

    <div class="drawer">
        <div class="p-3 border-b text-center">
            <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-2"></div>
            <div id="status" class="text-[11px] font-black text-blue-600 uppercase tracking-widest">èµ¤å´æ¨“å‘¨é‚Šå³æ™‚è»Šä½</div>
        </div>
        <div id="list-container"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false }).setView([22.997, 120.211], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const markerGroup = L.layerGroup().addTo(map);
        let centerMarker;

        async function runSearch() {
            const query = document.getElementById('search-input').value.trim();
            if (!query) return;
            updateStatus(`ğŸ” å®šä½ä¸­å¿ƒï¼š${query}`);
            try {
                const refinedQuery = query.includes("å°å—") ? query : `å°å— ${query}`;
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(refinedQuery)}&limit=1`);
                const data = await res.json();
                if (data && data[0]) {
                    updatePos(parseFloat(data[0].lat), parseFloat(data[0].lon), query);
                }
            } catch (err) { alert("æœå°‹å¤±æ•—"); }
        }

        document.getElementById('search-go').onclick = runSearch;
        document.getElementById('search-input').onkeydown = e => { if(e.key==='Enter') runSearch(); };

        function updatePos(lat, lng, label) {
            if (centerMarker) map.removeLayer(centerMarker);
            centerMarker = L.circleMarker([lat, lng], { radius: 10, color: '#fff', fillColor: '#ef4444', fillOpacity: 1, weight: 3 }).addTo(map);
            map.flyTo([lat, lng], 17);
            fetchParking(lat, lng);
        }

        async function fetchParking(lat, lng) {
            updateStatus("ğŸ“ æ­£åœ¨è¨ˆç®—ç‰©ç†è·é›¢æ’åº...");
            const list = document.getElementById('list-container');
            list.innerHTML = '<div class="p-12 text-center text-blue-500 font-bold animate-pulse">ç²¾ç¢ºè¨ˆç®—ä¸­...</div>';
            markerGroup.clearLayers();

            // æŠ“å–æ›´å¤§ç¯„åœï¼Œç„¶å¾Œåœ¨å‰ç«¯éæ¿¾èˆ‡æ’åº
            const offset = 0.015; 
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=åœè»Šå ´&limit=50&viewbox=${lng-offset},${lat+offset},${lng+offset},${lat-offset}&bounded=1`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                // --- é—œéµæ’åºé‚è¼¯ ---
                let sorted = data.map(p => {
                    const d = calculateDistance(lat, lng, parseFloat(p.lat), parseFloat(p.lon));
                    return { ...p, d };
                }).sort((a, b) => a.d - b.d); // å¼·åˆ¶ç”±è¿‘åˆ°é æ’åº

                list.innerHTML = '';
                sorted.forEach((p, index) => {
                    const name = p.display_name.split(',')[0];
                    const distStr = p.d > 1000 ? (p.d/1000).toFixed(1)+'km' : Math.round(p.d)+'m';
                    
                    // åªæœ‰å‰ä¸‰åçµ¦äºˆç‰¹æ®Šæ¨™è¨˜
                    const color = index === 0 ? '#10b981' : '#3b82f6';
                    L.marker([p.lat, p.lon], {icon: L.divIcon({className: '', html: `<div style="background:${color}; width:12px; height:12px; border-radius:50%; border:2px solid white;"></div>`})}).addTo(markerGroup);
                    
                    const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}&travelmode=driving`;
                    
                    const div = document.createElement('div');
                    div.className = "park-card";
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div class="font-bold text-slate-800 text-base leading-tight">${name}</div>
                            <span class="dist-tag">${distStr}</span>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <span class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded font-bold">æ¨è–¦é¦–é¸</span>
                            <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">ğŸ’° $30-40/hr</span>
                        </div>
                        <a href="${navUrl}" target="_blank" class="nav-btn">ğŸš™ å°èˆªè‡³æ­¤ (æœ€çŸ­è·¯å¾‘)</a>
                    `;
                    list.appendChild(div);
                });
                updateStatus(`âœ… å·²å®Œæˆæœ€çŸ­è·é›¢æ’åº`);
            } catch (e) { updateStatus("âŒ ç²å–å¤±æ•—"); }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function updateStatus(m) { document.getElementById('status').innerText = m; }
    </script>
</body>
</html>
